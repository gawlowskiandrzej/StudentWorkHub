name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20.x'
  DOTNET_VERSION: '8.0.x'

jobs:
  # Frontend linting and type checking
  frontend-lint:
    name: Frontend Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run ESLint
        working-directory: frontend
        run: npm run lint
      
      - name: Type check
        working-directory: frontend
        run: npx tsc --noEmit

  # Frontend unit tests
  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Run unit tests
        working-directory: frontend
        run: npm run test:unit
      
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/
          retention-days: 7

  # Frontend E2E tests
  #frontend-e2e-tests:
  #  name: Frontend E2E Tests
  #  runs-on: ubuntu-latest
  #  
  #  services:
  #    postgres-general:
  #      image: postgres:17.6
  #      env:
  #        POSTGRES_PASSWORD: postgres
  #        POSTGRES_DB: general
  #      ports:
  #        - 5433:5432
  #      options: >-
  #        --health-cmd pg_isready
  #        --health-interval 10s
  #        --health-timeout 5s
  #        --health-retries 5
  #    
  #    postgres-offers:
  #      image: postgres:17.6
  #      env:
  #        POSTGRES_PASSWORD: postgres
  #        POSTGRES_DB: offers
  #      ports:
  #        - 5432:5432
  #      options: >-
  #        --health-cmd pg_isready
  #        --health-interval 10s
  #        --health-timeout 5s
  #        --health-retries 5
  #    
  #    redis:
  #      image: redis:7
  #      ports:
  #        - 6379:6379
  #      options: >-
  #        --health-cmd "redis-cli ping"
  #        --health-interval 10s
  #        --health-timeout 5s
  #        --health-retries 5
  #  
  #  steps:
  #    - uses: actions/checkout@v4
  #    
  #    - name: Setup Node.js
  #      uses: actions/setup-node@v4
  #      with:
  #        node-version: ${{ env.NODE_VERSION }}
  #        cache: 'npm'
  #        cache-dependency-path: frontend/package-lock.json
  #    
  #    - name: Setup .NET
  #      uses: actions/setup-dotnet@v4
  #      with:
  #        dotnet-version: ${{ env.DOTNET_VERSION }}
  #    
  #    - name: Install frontend dependencies
  #      working-directory: frontend
  #      run: npm ci
  #    
  #    - name: Install Playwright browsers
  #      working-directory: frontend
  #      run: npx playwright install --with-deps chromium
  #    
  #    - name: Build backend
  #      working-directory: offer_collector
  #      run: dotnet build offer_manager/offer_manager.csproj -c Release
  #    
  #    - name: Start backend
  #      working-directory: offer_collector/offer_manager
  #      run: |
  #        dotnet bin/Release/net8.0/offer_manager.dll &
  #        echo $! > /tmp/backend.pid
  #      env:
  #        ASPNETCORE_ENVIRONMENT: Development
  #        ASPNETCORE_URLS: http://localhost:5059
  #        DatabaseSettings__Host: localhost
  #        DatabaseSettings__Port: 5432
  #        DatabaseSettings__Database: offers
  #        DatabaseSettings__Username: postgres
  #        DatabaseSettings__Password: postgres
  #        GeneralDatabaseSettings__Host: localhost
  #        GeneralDatabaseSettings__Port: 5433
  #        GeneralDatabaseSettings__Database: general
  #        GeneralDatabaseSettings__Username: postgres
  #        GeneralDatabaseSettings__Password: postgres
  #        RedisServer__Host: localhost
  #        RedisServer__Port: 6379
  #    
  #    - name: Wait for backend to be ready
  #      run: |
  #        for i in {1..30}; do
  #          if curl -f http://localhost:5059/api/health 2>/dev/null; then
  #            echo "Backend is ready"
  #            exit 0
  #          fi
  #          echo "Waiting for backend... ($i/30)"
  #          sleep 2
  #        done
  #        echo "Backend failed to start"
  #        exit 1
  #    
  #    - name: Build frontend
  #      working-directory: frontend
  #      run: npm run build
  #      env:
  #        BACKEND_URL: http://localhost:5059
  #    
  #    - name: Start frontend
  #      working-directory: frontend
  #      run: |
  #        npm run start &
  #        echo $! > /tmp/frontend.pid
  #      env:
  #        PORT: 4000
  #        BACKEND_URL: http://localhost:5059
  #    
  #    - name: Wait for frontend to be ready
  #      run: |
  #        for i in {1..30}; do
  #          if curl -f http://localhost:4000 2>/dev/null; then
  #            echo "Frontend is ready"
  #            exit 0
  #          fi
  #          echo "Waiting for frontend... ($i/30)"
  #          sleep 2
  #        done
  #        echo "Frontend failed to start"
  #        exit 1
  #    
  #    - name: Run E2E tests
  #      working-directory: frontend
  #      run: npm run test:e2e
  #      env:
  #        CI: true
  #    
  #    - name: Stop services
  #      if: always()
  #      run: |
  #        [ -f /tmp/frontend.pid ] && kill $(cat /tmp/frontend.pid) || true
  #        [ -f /tmp/backend.pid ] && kill $(cat /tmp/backend.pid) || true
  #    
  #    - name: Upload test results
  #      if: always()
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: playwright-report
  #        path: frontend/playwright-report/
  #        retention-days: 7
  #    
  #    - name: Upload test screenshots
  #      if: failure()
  #      uses: actions/upload-artifact@v4
  #      with:
  #        name: playwright-screenshots
  #        path: frontend/test-results/
  #        retention-days: 7

  # Backend tests
  backend-tests:
    name: Backend Tests (.NET)
    runs-on: ubuntu-latest
    
    services:
      postgres-general:
        image: postgres:17.6
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: general
        ports:
          - 5433:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres-offers:
        image: postgres:17.6
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: offers
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Restore dependencies
        working-directory: offer_collector
        run: |
          dotnet restore offer_manager/offer_manager.csproj
          dotnet restore worker/worker.csproj
          dotnet restore offer_manager.Tests/offer_manager.Tests.csproj
          dotnet restore worker.Tests/worker.Tests.csproj
      
      - name: Build
        working-directory: offer_collector
        run: |
          dotnet build offer_manager/offer_manager.csproj --no-restore -c Release
          dotnet build worker/worker.csproj --no-restore -c Release
          dotnet build offer_manager.Tests/offer_manager.Tests.csproj --no-restore -c Release
          dotnet build worker.Tests/worker.Tests.csproj --no-restore -c Release
      
      - name: Run tests
        working-directory: offer_collector
        run: |
          dotnet test offer_manager.Tests/offer_manager.Tests.csproj --no-build --verbosity normal -c Release
#          dotnet test worker.Tests/worker.Tests.csproj --no-build --verbosity normal -c Release
        env:
          DatabaseSettings__Host: localhost
          DatabaseSettings__Port: 5432
          DatabaseSettings__Database: offers
          DatabaseSettings__Username: postgres
          DatabaseSettings__Password: postgres
          GeneralDatabaseSettings__Host: localhost
          GeneralDatabaseSettings__Port: 5433
          GeneralDatabaseSettings__Database: general
          GeneralDatabaseSettings__Username: postgres
          GeneralDatabaseSettings__Password: postgres
          RedisServer__Host: localhost
          RedisServer__Port: 6379

  # Docker build test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: studentworkhub/frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build offer_manager Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./offer_collector
          file: ./offer_collector/Dockerfile.offer_manager
          push: false
          tags: studentworkhub/offer_manager:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner (Frontend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './frontend'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'trivy-frontend'
      
      - name: Run Trivy vulnerability scanner (Backend)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './offer_collector'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
      
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'trivy-backend'

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: 
      - frontend-lint
      - frontend-unit-tests
      #- frontend-e2e-tests
      - backend-tests
      - docker-build
      - security-scan
    if: always()
    
    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.frontend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-e2e-tests.result }}" != "success" ]] || \
             [[ "${{ needs.backend-tests.result }}" != "success" ]] || \
             [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully!"
