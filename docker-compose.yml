version: "3.9"

services:

  # -----------------------------
  # DATABASES
  # -----------------------------
  db_offers:
    build:
      context: ./databases/offers_database/container
    image: local/postgres-offers:17.6
    container_name: postgres-offers
    restart: unless-stopped
    env_file: ./databases/offers_database/container/.env
    ports:
      - "5432:5432"
    volumes:
      - pg_offers:/var/lib/postgresql/data
      - ./databases/offers_database/container/scripts:/docker-entrypoint-initdb.d:ro

  db_general:
    build:
      context: ./databases/general_database/container
    image: local/postgres-general:17.6
    container_name: postgres-general
    restart: unless-stopped
    env_file: ./databases/general_database/container/.env
    ports:
      - "5433:5432"
    volumes:
      - pg_general:/var/lib/postgresql/data
      - ./databases/general_database/container/scripts:/docker-entrypoint-initdb.d:ro

  # -----------------------------
  # REDIS
  # -----------------------------
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"

  # -----------------------------
  # FRONTEND (DEV)
  # -----------------------------
  frontend-dev:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend_dev
    ports:
      - "4000:4000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - MODE=development
    depends_on:
      - offer_manager

  # -----------------------------
  # FRONTEND (PROD)
  # -----------------------------
  frontend-prod:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend_prod
    ports:
      - "8080:80"
    environment:
      - MODE=production
    depends_on:
      - offer_manager

  # -----------------------------
  # OFFER MANAGER (.NET API)
  # -----------------------------
  offer_manager:
    build:
      context: ./offer_collector
      dockerfile: Dockerfile.offer_manager
    container_name: offer_manager
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      DatabaseSettings__Host: postgres-offers
      DatabaseSettings__Port: 5432
      DatabaseSettings__Database: ${POSTGRES_DB}
      DatabaseSettings__Username: ${POSTGRES_USER}
      DatabaseSettings__Password: ${POSTGRES_PASSWORD}
      RedisServer__Host: redis
      RedisServer__Port: 6379
      StaticSettings__NumberOfAvailablePortals: ${STATIC_NumberOfAvailablePortals}
      StaticSettings__JobsTimeoutMinutes: ${STATIC_JobsTimeoutMinutes}
      Frontend__PortProdApi: 7044
      Frontend__PortDevApi: 5059
      Frontend__IpProdApi: localhost
      Frontend__IpDevApi: offer_manager
      Frontend__PortDev: 4000
      Frontend__IpDev: frontend-dev
      ASPNETCORE_URLS: http://+:5059
    ports:
      - "5059:5059"
    depends_on:
      - redis
      - db_offers
      - headless_browser

  # -----------------------------
  # WORKER (.NET)
  # -----------------------------
  worker:
    build:
      context: ./offer_collector
      dockerfile: Dockerfile.worker
    container_name: worker
    
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      DatabaseSettings__Host: postgres-offers
      DatabaseSettings__Port: 5432
      DatabaseSettings__Database: ${POSTGRES_DB}
      DatabaseSettings__Username: ${POSTGRES_USER}
      DatabaseSettings__Password: ${POSTGRES_PASSWORD}
      RedisServer__Host: redis
      RedisServer__Port: 6379
      NodeServer__Host: headless_browser
      NodeServer__Port: 3000
      DelayBetweenRequestsMs: ${DELAY_BETWEEN_REQUESTS_MS}
      ASPNETCORE_URLS: http://+:80
    depends_on:
      - redis
      - db_offers
      - headless_browser

  # -----------------------------
  # HEADLESS NODE BROWSER
  # -----------------------------
  headless_browser:
    build:
      context: ./offer_collector/headless_browser
    container_name: headless_browser
    ports:
      - "3000:3000"

# -----------------------------
# VOLUMES
# -----------------------------
volumes:
  pg_offers:
  pg_general:
